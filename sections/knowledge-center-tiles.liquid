{% comment %}
  Simple Knowledge Center - Tile-based with Gated Access

  Installation:
  1. Shopify Admin ‚Üí Online Store ‚Üí Themes ‚Üí Edit code
  2. Sections ‚Üí Add a new section ‚Üí Name: knowledge-center-tiles
  3. Paste this code
  4. Add to any page via theme customizer

  Features:
  - Tiles can have rich-text content (expands on click)
  - Tiles can have links (navigates to URL)
  - Gated access via customer tags
  - Search and category filtering
{% endcomment %}

<div class="knowledge-center" id="kc-{{ section.id }}" data-section-id="{{ section.id }}">
  {% comment %} Welcome Section {% endcomment %}
  {% if section.settings.show_welcome %}
    <div class="kc-welcome">
      <h1>{{ section.settings.welcome_title }}</h1>
      {% if section.settings.welcome_text != blank %}
        <p>{{ section.settings.welcome_text }}</p>
      {% endif %}
    </div>
  {% endif %}

  {% comment %} Search Bar {% endcomment %}
  {% if section.settings.enable_search %}
    <div class="kc-search">
      <input
        type="text"
        class="kc-search-input"
        placeholder="{{ section.settings.search_placeholder }}"
        id="kc-search-{{ section.id }}"
      >
      <span class="kc-search-icon">üîç</span>
    </div>
  {% endif %}

  {% comment %} Category Filters {% endcomment %}
  {% if section.settings.enable_categories %}
    <div class="kc-categories" id="kc-categories-{{ section.id }}">
      <button class="kc-category-btn active" data-category="all">
        All
      </button>
      {% assign categories = section.settings.categories | split: ',' %}
      {% for category in categories %}
        {% assign cat_trimmed = category | strip %}
        {% if cat_trimmed != blank %}
          <button class="kc-category-btn" data-category="{{ cat_trimmed | handleize }}">
            {{ cat_trimmed }}
          </button>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}

  {% comment %} Tiles Grid {% endcomment %}
  <div class="kc-grid" id="kc-grid-{{ section.id }}">
    {% for block in section.blocks %}
      {% comment %} Check gated access {% endcomment %}
      {% assign show_tile = true %}
      {% if block.settings.required_tags != blank %}
        {% assign required_tags = block.settings.required_tags | split: ',' %}
        {% for required_tag in required_tags %}
          {% assign req_tag_trimmed = required_tag | strip %}
          {% unless customer.tags contains req_tag_trimmed %}
            {% assign show_tile = false %}
            {% break %}
          {% endunless %}
        {% endfor %}
      {% endif %}

      {% if show_tile %}
        {% assign has_content = false %}
        {% assign content_to_display = '' %}

        {% comment %} Priority: HTML Embed > Rich Text > Link {% endcomment %}
        {% if block.settings.html_embed != blank %}
          {% assign has_content = true %}
          {% assign content_to_display = block.settings.html_embed %}
        {% elsif block.settings.content != blank %}
          {% assign has_content = true %}
          {% assign content_to_display = block.settings.content %}
        {% endif %}

        {% assign has_link = false %}
        {% if block.settings.link != blank %}
          {% assign has_link = true %}
        {% endif %}

        {% if has_content %}
          {% comment %} Tile with expandable content {% endcomment %}
          <div
            class="kc-tile kc-tile-expandable"
            data-tile-id="tile-{{ block.id }}"
            data-category="{{ block.settings.category | handleize }}"
            data-title="{{ block.settings.title | escape }}"
            data-description="{{ block.settings.description | escape }}"
            {{ block.shopify_attributes }}
          >
            {% if block.settings.image != blank %}
              <div class="kc-tile-image">
                {{ block.settings.image | image_url: width: 600 | image_tag: alt: block.settings.title, loading: 'lazy' }}
              </div>
            {% endif %}

            <div class="kc-tile-content">
              {% if block.settings.category != blank %}
                <span class="kc-tile-category">{{ block.settings.category }}</span>
              {% endif %}

              <h3 class="kc-tile-title">{{ block.settings.title }}</h3>

              {% if block.settings.description != blank %}
                <p class="kc-tile-description">{{ block.settings.description }}</p>
              {% endif %}

              <span class="kc-tile-expand-icon">+</span>
            </div>

            {% comment %} Store content as hidden data {% endcomment %}
            <div class="kc-tile-content-data" id="content-{{ block.id }}" style="display: none;">
              {{ content_to_display }}
            </div>
          </div>

        {% elsif has_link %}
          {% comment %} Tile with link {% endcomment %}
          <a
            href="{{ block.settings.link }}"
            class="kc-tile kc-tile-link"
            data-category="{{ block.settings.category | handleize }}"
            data-title="{{ block.settings.title | escape }}"
            data-description="{{ block.settings.description | escape }}"
            {{ block.shopify_attributes }}
          >
            {% if block.settings.image != blank %}
              <div class="kc-tile-image">
                {{ block.settings.image | image_url: width: 600 | image_tag: alt: block.settings.title, loading: 'lazy' }}
              </div>
            {% endif %}

            <div class="kc-tile-content">
              {% if block.settings.category != blank %}
                <span class="kc-tile-category">{{ block.settings.category }}</span>
              {% endif %}

              <h3 class="kc-tile-title">{{ block.settings.title }}</h3>

              {% if block.settings.description != blank %}
                <p class="kc-tile-description">{{ block.settings.description }}</p>
              {% endif %}

              <span class="kc-tile-link-icon">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M3 13L13 3M13 3H5M13 3V11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
            </div>
          </a>

        {% else %}
          {% comment %} Basic tile (no content, no link) {% endcomment %}
          <div
            class="kc-tile"
            data-category="{{ block.settings.category | handleize }}"
            data-title="{{ block.settings.title | escape }}"
            data-description="{{ block.settings.description | escape }}"
            {{ block.shopify_attributes }}
          >
            {% if block.settings.image != blank %}
              <div class="kc-tile-image">
                {{ block.settings.image | image_url: width: 600 | image_tag: alt: block.settings.title, loading: 'lazy' }}
              </div>
            {% endif %}

            <div class="kc-tile-content">
              {% if block.settings.category != blank %}
                <span class="kc-tile-category">{{ block.settings.category }}</span>
              {% endif %}

              <h3 class="kc-tile-title">{{ block.settings.title }}</h3>

              {% if block.settings.description != blank %}
                <p class="kc-tile-description">{{ block.settings.description }}</p>
              {% endif %}
            </div>
          </div>
        {% endif %}
      {% endif %}
    {% endfor %}
  </div>

  {% comment %} Full-width content frame (positioned outside grid) {% endcomment %}
  <div class="kc-content-frame" id="kc-content-frame-{{ section.id }}" style="display: none;">
    <div class="kc-content-frame-inner">
      <button class="kc-content-close" aria-label="Close">√ó</button>
      <div class="kc-content-body" id="kc-content-body-{{ section.id }}">
        <!-- Content will be injected here -->
      </div>
    </div>
  </div>

  {% comment %} Empty State {% endcomment %}
  <div class="kc-empty" id="kc-empty-{{ section.id }}" style="display: none;">
    <div class="kc-empty-icon">üìÑ</div>
    <h3>No results found</h3>
    <p>Try adjusting your search or filters</p>
  </div>
</div>

<style>
  .knowledge-center {
    max-width: {{ section.settings.max_width }}px;
    margin: 0 auto;
    padding: {{ section.settings.section_padding }}px 20px;
  }

  .kc-welcome {
    text-align: center;
    margin-bottom: 40px;
  }

  .kc-welcome h1 {
    font-size: 2.5rem;
    color: {{ section.settings.primary_color }};
    margin-bottom: 12px;
  }

  .kc-welcome p {
    font-size: 1.125rem;
    color: {{ section.settings.text_color }};
    opacity: 0.8;
  }

  .kc-search {
    max-width: 600px;
    margin: 0 auto 30px;
    position: relative;
  }

  .kc-search-input {
    width: 100%;
    padding: 12px 40px 12px 16px;
    font-size: 1rem;
    border: 2px solid {{ section.settings.border_color }};
    border-radius: {{ section.settings.border_radius }}px;
    outline: none;
    transition: border-color 0.2s;
  }

  .kc-search-input:focus {
    border-color: {{ section.settings.primary_color }};
  }

  .kc-search-icon {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: {{ section.settings.text_color }};
    opacity: 0.5;
  }

  .kc-categories {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: center;
    margin-bottom: 40px;
  }

  .kc-category-btn {
    padding: 8px 20px;
    border: 2px solid {{ section.settings.border_color }};
    border-radius: {{ section.settings.border_radius }}px;
    background: white;
    color: {{ section.settings.text_color }};
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .kc-category-btn:hover {
    border-color: {{ section.settings.primary_color }};
    background: {{ section.settings.primary_color }}15;
  }

  .kc-category-btn.active {
    border-color: {{ section.settings.primary_color }};
    background: {{ section.settings.primary_color }};
    color: white;
  }

  .kc-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax({{ section.settings.tile_min_width }}px, 1fr));
    gap: {{ section.settings.grid_gap }}px;
    margin-bottom: 20px;
  }

  .kc-tile {
    background: white;
    border: 1px solid {{ section.settings.border_color }};
    border-radius: {{ section.settings.border_radius }}px;
    overflow: hidden;
    transition: all 0.3s;
    text-decoration: none;
    color: inherit;
    display: flex;
    flex-direction: column;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .kc-tile:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .kc-tile-expandable {
    cursor: pointer;
    position: relative;
  }

  .kc-tile-expandable.active {
    border-color: {{ section.settings.primary_color }};
    box-shadow: 0 0 0 2px {{ section.settings.primary_color }}33;
  }

  .kc-tile-link {
    position: relative;
  }

  .kc-tile-content-data {
    display: none !important;
  }

  .kc-tile-image {
    width: 100%;
    aspect-ratio: {{ section.settings.image_aspect_ratio }};
    overflow: hidden;
    background: #f8f9fa;
  }

  .kc-tile-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .kc-tile-content {
    padding: 20px;
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
  }

  .kc-tile-category {
    display: inline-block;
    padding: 4px 12px;
    background: {{ section.settings.primary_color }}15;
    color: {{ section.settings.primary_color }};
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-bottom: 12px;
    width: fit-content;
  }

  .kc-tile-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 8px;
    color: {{ section.settings.heading_color }};
  }

  .kc-tile-description {
    font-size: 0.875rem;
    color: {{ section.settings.text_color }};
    opacity: 0.8;
    line-height: 1.6;
  }

  .kc-tile-expand-icon {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: {{ section.settings.primary_color }};
    color: white;
    border-radius: 50%;
    font-size: 1.25rem;
    font-weight: 300;
    transition: transform 0.3s;
  }

  .kc-tile-expandable.expanded .kc-tile-expand-icon {
    transform: rotate(45deg);
  }

  .kc-tile-link-icon {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: {{ section.settings.primary_color }};
    color: white;
    border-radius: 50%;
    transition: transform 0.3s;
  }

  .kc-tile-link:hover .kc-tile-link-icon {
    transform: translate(2px, -2px);
  }

  /* Full-width content frame */
  .kc-content-frame {
    width: 100vw;
    position: relative;
    left: 50%;
    right: 50%;
    margin-left: -50vw;
    margin-right: -50vw;
    margin-top: 30px;
    margin-bottom: 30px;
    background: white;
    border-top: 3px solid {{ section.settings.primary_color }};
    border-bottom: 3px solid {{ section.settings.primary_color }};
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .kc-content-frame-inner {
    max-width: {{ section.settings.max_width }}px;
    margin: 0 auto;
    padding: 40px 20px;
    position: relative;
  }

  .kc-content-close {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 36px;
    height: 36px;
    border: 2px solid {{ section.settings.border_color }};
    border-radius: 50%;
    background: white;
    color: {{ section.settings.text_color }};
    font-size: 24px;
    line-height: 1;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
  }

  .kc-content-close:hover {
    background: {{ section.settings.primary_color }};
    border-color: {{ section.settings.primary_color }};
    color: white;
    transform: rotate(90deg);
  }

  .kc-content-body {
    padding-right: 60px;
    line-height: 1.8;
    color: {{ section.settings.text_color }};
  }

  .kc-content-body h2,
  .kc-content-body h3,
  .kc-content-body h4 {
    color: {{ section.settings.heading_color }};
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
  }

  .kc-content-body h2 {
    font-size: 1.75rem;
  }

  .kc-content-body h3 {
    font-size: 1.5rem;
  }

  .kc-content-body h4 {
    font-size: 1.25rem;
  }

  .kc-content-body p {
    margin-bottom: 1rem;
  }

  .kc-content-body ul,
  .kc-content-body ol {
    margin-bottom: 1rem;
    padding-left: 2rem;
  }

  .kc-content-body li {
    margin-bottom: 0.5rem;
  }

  .kc-content-body img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 1.5rem 0;
  }

  .kc-content-body a {
    color: {{ section.settings.primary_color }};
    text-decoration: underline;
  }

  .kc-content-body a:hover {
    opacity: 0.8;
  }

  /* Responsive embeds (iframes, videos) */
  .kc-content-body iframe {
    max-width: 100%;
    border-radius: 8px;
    margin: 1.5rem 0;
  }

  .kc-content-body video {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 1.5rem 0;
  }

  .kc-empty {
    text-align: center;
    padding: 60px 20px;
    color: {{ section.settings.text_color }};
    opacity: 0.6;
  }

  .kc-empty-icon {
    font-size: 4rem;
    margin-bottom: 16px;
  }

  @media (max-width: 768px) {
    .kc-welcome h1 {
      font-size: 2rem;
    }

    .kc-grid {
      grid-template-columns: 1fr;
    }

    .kc-categories {
      overflow-x: auto;
      justify-content: flex-start;
      padding-bottom: 8px;
    }

    .kc-category-btn {
      flex-shrink: 0;
    }

    .kc-content-frame-inner {
      padding: 30px 15px;
    }

    .kc-content-body {
      padding-right: 0;
    }

    .kc-content-close {
      top: 15px;
      right: 15px;
      width: 32px;
      height: 32px;
      font-size: 20px;
    }
  }
</style>

<script>
(function() {
  const sectionId = '{{ section.id }}';
  const searchInput = document.getElementById('kc-search-' + sectionId);
  const grid = document.getElementById('kc-grid-' + sectionId);
  const emptyState = document.getElementById('kc-empty-' + sectionId);
  const categoryBtns = document.querySelectorAll('#kc-categories-' + sectionId + ' .kc-category-btn');
  const contentFrame = document.getElementById('kc-content-frame-' + sectionId);
  const contentBody = document.getElementById('kc-content-body-' + sectionId);
  const allTiles = grid.querySelectorAll('.kc-tile');

  let currentCategory = 'all';
  let currentSearch = '';

  // Category filtering
  categoryBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      categoryBtns.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      currentCategory = this.dataset.category;
      closeContentFrame();
      filterTiles();
    });
  });

  // Search filtering
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      currentSearch = this.value.toLowerCase();
      closeContentFrame();
      filterTiles();
    });
  }

  // Expandable tile clicks
  document.querySelectorAll('.kc-tile-expandable').forEach(tile => {
    tile.addEventListener('click', function() {
      const tileId = this.dataset.tileId;
      const contentId = tileId.replace('tile-', 'content-');
      const contentData = document.getElementById(contentId);

      if (!contentData) return;

      const isActive = this.classList.contains('active');

      if (isActive) {
        // Close if clicking the same tile
        closeContentFrame();
      } else {
        // Open with new content
        openContentFrame(this, contentData.innerHTML);
      }
    });
  });

  // Close button
  const closeBtn = contentFrame.querySelector('.kc-content-close');
  if (closeBtn) {
    closeBtn.addEventListener('click', function() {
      closeContentFrame();
    });
  }

  function openContentFrame(tile, content) {
    // Remove active state from all tiles
    document.querySelectorAll('.kc-tile-expandable').forEach(t => {
      t.classList.remove('active');
    });

    // Add active state to clicked tile
    tile.classList.add('active');

    // Inject content
    contentBody.innerHTML = content;

    // Show frame
    contentFrame.style.display = 'block';

    // Smooth scroll to content frame
    setTimeout(() => {
      contentFrame.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
  }

  function closeContentFrame() {
    // Hide frame
    contentFrame.style.display = 'none';

    // Remove active state from all tiles
    document.querySelectorAll('.kc-tile-expandable').forEach(t => {
      t.classList.remove('active');
    });

    // Clear content
    contentBody.innerHTML = '';
  }

  function filterTiles() {
    let visibleCount = 0;

    allTiles.forEach(tile => {
      const category = tile.dataset.category || '';
      const title = (tile.dataset.title || '').toLowerCase();
      const description = (tile.dataset.description || '').toLowerCase();

      const matchesCategory = currentCategory === 'all' || category === currentCategory;
      const matchesSearch = currentSearch === '' ||
                           title.includes(currentSearch) ||
                           description.includes(currentSearch);

      if (matchesCategory && matchesSearch) {
        tile.style.display = 'flex';
        visibleCount++;
      } else {
        tile.style.display = 'none';
      }
    });

    // Show/hide empty state
    if (emptyState) {
      emptyState.style.display = visibleCount === 0 ? 'block' : 'none';
    }
  }
})();
</script>

{% schema %}
{
  "name": "Knowledge Center",
  "settings": [
    {
      "type": "header",
      "content": "Welcome Section"
    },
    {
      "type": "checkbox",
      "id": "show_welcome",
      "label": "Show Welcome Section",
      "default": true
    },
    {
      "type": "text",
      "id": "welcome_title",
      "label": "Welcome Title",
      "default": "Knowledge Center"
    },
    {
      "type": "textarea",
      "id": "welcome_text",
      "label": "Welcome Text",
      "default": "Find helpful articles, tutorials, and guides"
    },
    {
      "type": "header",
      "content": "Search"
    },
    {
      "type": "checkbox",
      "id": "enable_search",
      "label": "Enable Search",
      "default": true
    },
    {
      "type": "text",
      "id": "search_placeholder",
      "label": "Search Placeholder",
      "default": "Search..."
    },
    {
      "type": "header",
      "content": "Categories"
    },
    {
      "type": "checkbox",
      "id": "enable_categories",
      "label": "Enable Categories",
      "default": true
    },
    {
      "type": "text",
      "id": "categories",
      "label": "Categories (comma-separated)",
      "default": "Getting Started, Tutorials, FAQ, Troubleshooting, Affiliates",
      "info": "Add your category names separated by commas"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "max_width",
      "label": "Maximum Width",
      "min": 800,
      "max": 1600,
      "step": 100,
      "default": 1200,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "section_padding",
      "label": "Section Padding",
      "min": 0,
      "max": 100,
      "step": 10,
      "default": 40,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "tile_min_width",
      "label": "Tile Minimum Width",
      "min": 200,
      "max": 400,
      "step": 50,
      "default": 300,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "grid_gap",
      "label": "Grid Gap",
      "min": 10,
      "max": 40,
      "step": 5,
      "default": 20,
      "unit": "px"
    },
    {
      "type": "select",
      "id": "image_aspect_ratio",
      "label": "Image Aspect Ratio",
      "options": [
        { "value": "16/9", "label": "16:9 (Landscape)" },
        { "value": "4/3", "label": "4:3" },
        { "value": "1/1", "label": "1:1 (Square)" },
        { "value": "3/4", "label": "3:4 (Portrait)" }
      ],
      "default": "16/9"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Border Radius",
      "min": 0,
      "max": 20,
      "step": 2,
      "default": 8,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "Primary Color",
      "default": "#2563eb"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#1e293b"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#64748b"
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Border Color",
      "default": "#e2e8f0"
    }
  ],
  "blocks": [
    {
      "type": "tile",
      "name": "Tile",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Article Title"
        },
        {
          "type": "textarea",
          "id": "description",
          "label": "Description",
          "default": "Short description of this article"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "Content (Rich Text)",
          "info": "Add content here to make tile expandable. Leave empty if using HTML Embed or Link instead."
        },
        {
          "type": "html",
          "id": "html_embed",
          "label": "HTML Embed",
          "info": "Paste HTML code (iframe, video embed, etc.). Takes priority over Rich Text. Leave empty if using Rich Text or Link."
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link (External URL)",
          "info": "Link to page, article, video, or external URL. Only used if Content and HTML Embed are empty."
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "category",
          "label": "Category",
          "info": "Must match one of the categories above"
        },
        {
          "type": "text",
          "id": "required_tags",
          "label": "Required Customer Tags (for gated access)",
          "info": "Comma-separated. Leave empty for public. Example: affiliates, vip"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Knowledge Center",
      "blocks": [
        {
          "type": "tile",
          "settings": {
            "title": "Getting Started",
            "description": "Learn the basics",
            "category": "Getting Started"
          }
        },
        {
          "type": "tile",
          "settings": {
            "title": "FAQ",
            "description": "Frequently asked questions",
            "category": "FAQ"
          }
        }
      ]
    }
  ]
}
{% endschema %}
