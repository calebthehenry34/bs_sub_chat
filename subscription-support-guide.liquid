/**
 * Shopify Theme-Only Chat Features
 * Fixed: Prevents duplicates, prioritizes custom intents
 */

class ShopifyChatFeatures {
  constructor(config = {}) {
    this.config = {
      loggingUrl: config.loggingUrl || null,
      customer: config.customer || null,
      shopDomain: config.shopDomain || window.Shopify?.shop,
      
      // Feature flags
      enablePersistence: config.enablePersistence !== false,
      enableAutoComplete: config.enableAutoComplete !== false,
      enableQuickReplies: config.enableQuickReplies !== false,
      enableHistory: config.enableHistory !== false,
      enableOrderLookup: config.enableOrderLookup !== false,
      
      // Priority settings
      prioritizeCustomIntents: config.prioritizeCustomIntents !== false,
      onlyShowQuickRepliesOnce: config.onlyShowQuickRepliesOnce !== false,
      
      ...config
    };

    this.sessionId = this.getOrCreateSessionId();
    this.conversationContext = {
      messages: [],
      lastIntent: null,
      metadata: {},
      processedMessages: new Set(), // Track processed messages to prevent duplicates
      quickRepliesShown: false      // Track if quick replies already shown
    };

    // Debounce timers
    this.debounceTimers = {
      quickReplies: null,
      messages: null
    };

    this.init();
  }

  init() {
    console.log('üéØ Initializing Shopify Chat Features (Deduplication Mode)');
    
    if (this.config.enablePersistence) {
      this.loadPersistedSession();
      this.setupAutoSave();
    }

    if (this.config.enableAutoComplete) {
      this.initAutoComplete();
    }

    if (this.config.enableQuickReplies) {
      this.initQuickReplies();
    }

    if (this.config.enableHistory && this.config.customer) {
      this.showWelcomeBack();
    }

    this.initGDPRTools();

    // Hook into existing system to prevent duplicates
    this.hookIntoExistingSystem();
  }

  /**
   * ========================================
   * DEDUPLICATION & INTEGRATION
   * ========================================
   */

  hookIntoExistingSystem() {
    // Store reference to original functions
    const originalAddBotMessage = window.addBotMessage;
    const originalHandleAIIntent = window.handleAIIntent;
    const originalRouteIntent = window.routeIntent;

    // Wrap addBotMessage to track what's been added
    if (originalAddBotMessage) {
      window.addBotMessage = (message, options = {}) => {
        // Track this message
        const messageHash = this.hashMessage(message);
        this.conversationContext.processedMessages.add(messageHash);
        
        // Call original
        return originalAddBotMessage(message, options);
      };
    }

    // Wrap handleAIIntent to update context but prevent duplicate actions
    if (originalHandleAIIntent) {
      window.handleAIIntent = (intent, message) => {
        // Update our context FIRST
        this.conversationContext.lastIntent = intent;
        
        // Call original (which will add messages)
        const result = originalHandleAIIntent(intent, message);
        
        // ONLY show our quick replies if the original didn't show any
        // and if we haven't shown them yet
        if (this.config.enableQuickReplies && !this.conversationContext.quickRepliesShown) {
          // Wait a bit to see if custom handler added quick replies
          clearTimeout(this.debounceTimers.quickReplies);
          this.debounceTimers.quickReplies = setTimeout(() => {
            if (!this.hasQuickRepliesInDOM()) {
              this.updateQuickReplies({ intent });
            }
          }, 100);
        }
        
        return result;
      };
    }

    // Wrap routeIntent to track custom intent handling
    if (originalRouteIntent) {
      window.routeIntent = (intent, message) => {
        // Mark that we're processing a custom intent
        this.conversationContext.processingCustomIntent = true;
        
        // Call original
        const result = originalRouteIntent(intent, message);
        
        // Reset flag after a bit
        setTimeout(() => {
          this.conversationContext.processingCustomIntent = false;
        }, 500);
        
        return result;
      };
    }
  }

  hasQuickRepliesInDOM() {
    // Check if quick replies are already in the DOM from another source
    const existingReplies = document.querySelectorAll('.quick-reply-btn, [data-quick-reply]');
    return existingReplies.length > 0;
  }

  hashMessage(message) {
    // Create a simple hash of the message to detect duplicates
    if (typeof message !== 'string') return null;
    
    // Normalize message (remove HTML, trim, lowercase)
    const normalized = message.replace(/<[^>]*>/g, '').trim().toLowerCase();
    
    // Simple hash
    let hash = 0;
    for (let i = 0; i < normalized.length; i++) {
      const char = normalized.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    return hash.toString(36);
  }

  isMessageDuplicate(message) {
    const messageHash = this.hashMessage(message);
    return this.conversationContext.processedMessages.has(messageHash);
  }

  /**
   * ========================================
   * CHAT PERSISTENCE
   * ========================================
   */

  getOrCreateSessionId() {
    let sessionId = localStorage.getItem('chat_session_id');
    if (!sessionId) {
      sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('chat_session_id', sessionId);
    }
    return sessionId;
  }

  loadPersistedSession() {
    try {
      const savedData = localStorage.getItem('chat_session_data');
      if (savedData) {
        const sessionData = JSON.parse(savedData);
        this.conversationContext.lastIntent = sessionData.conversationContext?.lastIntent;
        this.conversationContext.metadata = sessionData.conversationContext?.metadata || {};
        
        // Restore messages
        if (sessionData.messages && sessionData.messages.length > 0) {
          console.log('üì• Restoring', sessionData.messages.length, 'messages');
          this.restoreMessages(sessionData.messages);
        }
      }
    } catch (error) {
      console.error('Failed to load session:', error);
    }
  }

  saveSession() {
    try {
      const sessionData = {
        sessionId: this.sessionId,
        conversationContext: {
          lastIntent: this.conversationContext.lastIntent,
          metadata: this.conversationContext.metadata
        },
        customerId: this.config.customer?.email,
        messages: this.conversationContext.messages,
        savedAt: new Date().toISOString()
      };

      localStorage.setItem('chat_session_data', JSON.stringify(sessionData));
      
      if (this.config.customer?.email) {
        this.saveToCustomerHistory(sessionData);
      }
    } catch (error) {
      console.error('Failed to save session:', error);
    }
  }

  saveToCustomerHistory(sessionData) {
    try {
      const customerEmail = this.config.customer.email;
      const historyKey = 'chat_history_' + this.hashEmail(customerEmail);
      
      let history = JSON.parse(localStorage.getItem(historyKey) || '[]');
      history.push({
        sessionId: sessionData.sessionId,
        timestamp: sessionData.savedAt,
        messageCount: sessionData.messages.length,
        lastIntent: sessionData.conversationContext.lastIntent
      });
      
      if (history.length > 10) {
        history = history.slice(-10);
      }
      
      localStorage.setItem(historyKey, JSON.stringify(history));
    } catch (error) {
      console.error('Failed to save to history:', error);
    }
  }

  setupAutoSave() {
    setInterval(() => {
      if (this.conversationContext.messages.length > 0) {
        this.saveSession();
      }
    }, 30000);

    window.addEventListener('beforeunload', () => {
      this.saveSession();
    });
  }

  restoreMessages(messages) {
    messages.forEach(msg => {
      // Track as already processed to prevent duplicates
      const messageHash = this.hashMessage(msg.message);
      this.conversationContext.processedMessages.add(messageHash);
      
      // Restore to UI
      if (msg.sender === 'user') {
        this.addMessageToUI(msg.message, 'user', false, true);
      } else {
        this.addMessageToUI(msg.message, 'bot', msg.isHtml, true);
      }
    });
  }

  /**
 * ========================================
 * AUTO-COMPLETE SUGGESTIONS (Pill Style)
 * ========================================
 */

initAutoComplete() {
  const chatInput = document.querySelector('#chat-input') || 
                   document.querySelector('[data-chat-input]') ||
                   document.querySelector('textarea');

  if (!chatInput) return;

  const suggestionsContainer = document.createElement('div');
  suggestionsContainer.className = 'chat-suggestions-pills';
  suggestionsContainer.style.cssText = `
    position: absolute;
    bottom: 130%;
    left: 0;
    right: 0;
    padding: 12px;
    display: none;
    gap: 8px;
    flex-wrap: wrap;
    backdrop-filter: blur(30px);
    border-radius: 15px;
    box-shadow: rgba(0, 0, 0, 0.05) 0px 0px 7
    z-index: 1000;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.3s ease, transform 0.3s ease;
        background: linear-gradient(359deg, #ffffff, #ffffff00);
  `;

  chatInput.parentElement.style.position = 'relative';
  chatInput.parentElement.appendChild(suggestionsContainer);

  let debounceTimer;
  let isVisible = false;

  chatInput.addEventListener('input', (e) => {
    clearTimeout(debounceTimer);
    const input = e.target.value;

    if (input.length < 2) {
      this.hideSuggestions(suggestionsContainer);
      isVisible = false;
      return;
    }

    debounceTimer = setTimeout(() => {
      this.showSuggestions(input, suggestionsContainer, chatInput);
      isVisible = true;
    }, 200);
  });

  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isVisible) {
      e.preventDefault();
      this.hideSuggestions(suggestionsContainer);
      isVisible = false;
    }
    
    if (e.key === 'Enter' && isVisible) {
      this.hideSuggestions(suggestionsContainer);
      isVisible = false;
    }
  });

  document.addEventListener('click', (e) => {
    if (!chatInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
      if (isVisible) {
        this.hideSuggestions(suggestionsContainer);
        isVisible = false;
      }
    }
  });

  this.suggestionsContainer = suggestionsContainer;
}

showSuggestions(input, container, chatInput) {
  const suggestions = this.getSuggestions(input);

  if (suggestions.length === 0) {
    this.hideSuggestions(container);
    return;
  }

  container.innerHTML = '';

  suggestions.forEach(suggestion => {
    const pill = document.createElement('button');
    pill.className = 'suggestion-pill';
    pill.textContent = suggestion.text;
    pill.dataset.text = suggestion.text;
    
    pill.style.cssText = `
      padding: 10px 18px;
      background: #ffffff70;
      1.5px solid rgb(237 237 237 / 50%);
      border-radius: 24px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      color: #333;
      transition: all 0.2s ease;
      flex-shrink: 0;
    `;

    pill.addEventListener('mouseenter', () => {
      pill.style.background = '#f8f8f8';
      pill.style.borderColor = '#999';
      pill.style.transform = 'translateY(-2px)';
      pill.style.boxShadow = '0 4px 8px rgba(0,0,0,0.08)';
    });

    pill.addEventListener('mouseleave', () => {
      pill.style.background = 'white';
      pill.style.borderColor = '#e0e0e0';
      pill.style.transform = 'translateY(0)';
      pill.style.boxShadow = '0 2px 4px rgba(0,0,0,0.04)';
    });

    pill.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      chatInput.value = pill.dataset.text;
      this.hideSuggestions(container);
      chatInput.focus();
      
      setTimeout(() => {
        const event = new KeyboardEvent('keydown', { 
          key: 'Enter', 
          keyCode: 13,
          bubbles: true 
        });
        chatInput.dispatchEvent(event);
      }, 100);
    });

    container.appendChild(pill);
  });

  container.style.display = 'flex';
  container.offsetHeight;
  
  requestAnimationFrame(() => {
    container.style.opacity = '1';
    container.style.transform = 'translateY(0)';
  });
}

hideSuggestions(container) {
  container.style.opacity = '0';
  container.style.transform = 'translateY(10px)';
  
  setTimeout(() => {
    container.style.display = 'none';
  }, 300);
}

getSuggestions(input) {
  const query = input.toLowerCase().trim();
  const templates = this.getSuggestionTemplates();
  const matches = [];

  for (const [category, items] of Object.entries(templates)) {
    items.forEach(item => {
      const score = this.matchScore(query, item.text.toLowerCase());
      if (score > 0) {
        matches.push({
          text: item.text,
          category: category,
          score: score
        });
      }
    });
  }

  matches.sort((a, b) => b.score - a.score);
  return matches.slice(0, 6);
}

matchScore(query, text) {
  if (text.includes(query)) {
    const position = text.indexOf(query);
    return 100 - position;
  }

  const queryWords = query.split(/\s+/);
  const textWords = text.split(/\s+/);
  let matchedWords = 0;

  queryWords.forEach(qWord => {
    if (textWords.some(tWord => tWord.startsWith(qWord))) {
      matchedWords++;
    }
  });

  return (matchedWords / queryWords.length) * 50;
}

getSuggestionTemplates() {
  return {
    'Orders': [
      { text: 'Where is my order?' },
      { text: 'Track my order' },
      { text: 'When will my order arrive?' },
      { text: 'I haven\'t received my order' },
      { text: 'View my order history' }
    ],
    'Subscriptions': [
      { text: 'Cancel my subscription' },
      { text: 'Pause my subscription' },
      { text: 'Update my subscription address' },
      { text: 'Change subscription frequency' },
      { text: 'When is my next delivery?' },
      { text: 'Update payment method' }
    ],
    'Account': [
      { text: 'Update my email address' },
      { text: 'Change my password' },
      { text: 'Update my shipping address' },
      { text: 'View my account information' },
      { text: 'Delete my account' }
    ],
    'Products': [
      { text: 'Is this product in stock?' },
      { text: 'Tell me about this product' },
      { text: 'Do you have any deals?' },
      { text: 'Show me your best sellers' }
    ],
    'Support': [
      { text: 'I need help' },
      { text: 'Talk to a human' },
      { text: 'Contact customer support' },
      { text: 'File a complaint' },
      { text: 'Request a refund' }
    ]
  };
}

  /**
   * ========================================
   * SMART QUICK REPLIES (Deduplication)
   * ========================================
   */

  initQuickReplies() {
    // Only create container if it doesn't exist
    if (document.querySelector('.quick-replies-container')) {
      this.quickRepliesContainer = document.querySelector('.quick-replies-container');
      return;
    }

    this.quickRepliesContainer = document.createElement('div');
    this.quickRepliesContainer.className = 'quick-replies-container';
    this.quickRepliesContainer.style.cssText = `
      padding: 12px;
      display: none;
      gap: 8px;
      overflow-x: auto;
      background: #fafafa;
      border-top: 1px solid #e0e0e0;
      scrollbar-width: thin;
    `;

    const chatContainer = document.querySelector('#chat-container') ||
                         document.querySelector('[data-chat-container]') ||
                         document.querySelector('.chat-widget');

    if (chatContainer) {
      chatContainer.appendChild(this.quickRepliesContainer);
    }
  }

  updateQuickReplies(context = {}) {
    if (!this.quickRepliesContainer) return;

    // Don't show if we're processing a custom intent
    if (this.conversationContext.processingCustomIntent && this.config.prioritizeCustomIntents) {
      console.log('‚è≠Ô∏è Skipping quick replies - custom intent is being processed');
      return;
    }

    // Don't show if quick replies already exist from custom handlers
    if (this.hasQuickRepliesInDOM() && this.quickRepliesContainer.children.length === 0) {
      console.log('‚è≠Ô∏è Skipping quick replies - already shown by custom handler');
      return;
    }

    // Only show once per intent if configured
    if (this.config.onlyShowQuickRepliesOnce && this.conversationContext.quickRepliesShown) {
      return;
    }

    const replies = this.getQuickReplies(context);

    if (replies.length === 0) {
      this.quickRepliesContainer.style.display = 'none';
      return;
    }

    // Clear existing to prevent duplicates
    this.quickRepliesContainer.innerHTML = '';

    this.quickRepliesContainer.innerHTML = replies.map(reply => `
      <button class="quick-reply-btn" 
              data-text="${this.escapeHtml(reply.text)}"
              data-action="${reply.action}"
              style="
        padding: 10px 18px;
        background: white;
        border: 1.5px solid #e0e0e0;
        border-radius: 24px;
        cursor: pointer;
        white-space: nowrap;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
        flex-shrink: 0;
      ">
        <span>${reply.icon}</span>
        <span>${this.escapeHtml(reply.text)}</span>
      </button>
    `).join('');

    this.quickRepliesContainer.querySelectorAll('.quick-reply-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        this.handleQuickReply(btn.dataset.action, btn.dataset.text);
      });

      btn.addEventListener('mouseenter', () => {
        btn.style.background = '#f0f0f0';
        btn.style.borderColor = '#999';
        btn.style.transform = 'translateY(-1px)';
      });

      btn.addEventListener('mouseleave', () => {
        btn.style.background = 'white';
        btn.style.borderColor = '#e0e0e0';
        btn.style.transform = 'translateY(0)';
      });
    });

    this.quickRepliesContainer.style.display = 'flex';
    this.conversationContext.quickRepliesShown = true;
  }

  getQuickReplies(context = {}) {
    const lastIntent = context.intent || context.lastIntent || this.conversationContext.lastIntent;

    // Don't show generic quick replies if there's a custom handler for this intent
    if (this.config.prioritizeCustomIntents && this.hasCustomIntentHandler(lastIntent)) {
      console.log(`‚è≠Ô∏è Skipping generic quick replies - custom handler exists for ${lastIntent}`);
      return [];
    }

    // Context-based quick replies
    if (lastIntent === 'subscription_info' || lastIntent === 'subscription_manage') {
      return [
        { text: 'Pause', action: 'subscription_pause', icon: '‚è∏Ô∏è' },
        { text: 'Update Address', action: 'subscription_address', icon: 'üìç' },
        { text: 'Change Frequency', action: 'subscription_frequency', icon: 'üîÑ' },
        { text: 'Cancel', action: 'subscription_cancel', icon: '‚ùå' }
      ];
    }

    if (lastIntent === 'order_tracking' || lastIntent === 'order_status') {
      return [
        { text: 'Track Another', action: 'order_track_another', icon: 'üîç' },
        { text: 'Order History', action: 'order_history', icon: 'üìã' },
        { text: 'Contact Support', action: 'support', icon: 'üí¨' }
      ];
    }

    // Default quick replies (only if no custom intent)
    if (!lastIntent || lastIntent === 'greeting' || lastIntent === 'general') {
      return [
        { text: 'Track Order', action: 'order_tracking', icon: 'üì¶' },
        { text: 'Subscriptions', action: 'subscription_info', icon: 'üîÑ' },
        { text: 'My Account', action: 'account_info', icon: 'üë§' },
        { text: 'Contact Support', action: 'support', icon: 'üí¨' }
      ];
    }

    return [];
  }

  hasCustomIntentHandler(intent) {
    // Check if there's a custom handler function for this intent
    const handlerName = `handle${intent.charAt(0).toUpperCase() + intent.slice(1).replace(/_([a-z])/g, (_, c) => c.toUpperCase())}`;
    return typeof window[handlerName] === 'function';
  }

  clearQuickReplies() {
    if (this.quickRepliesContainer) {
      this.quickRepliesContainer.innerHTML = '';
      this.quickRepliesContainer.style.display = 'none';
      this.conversationContext.quickRepliesShown = false;
    }
  }

  handleQuickReply(action, text) {
    // Clear quick replies
    this.clearQuickReplies();
    
    // Send message to chat
    this.sendMessage(text);

    // Handle specific actions (only if no custom handler)
    if (!this.hasCustomIntentHandler(action)) {
      switch (action) {
        case 'order_tracking':
          this.promptOrderLookup();
          break;
        case 'order_history':
          this.showOrderHistory();
          break;
        case 'subscription_info':
          this.showSubscriptionInfo();
          break;
        case 'account_info':
          this.showAccountInfo();
          break;
      }
    }

    // Update context
    this.conversationContext.lastIntent = action;
    this.saveSession();
  }

  /**
   * ========================================
   * MESSAGE HANDLING (Deduplication)
   * ========================================
   */

  addMessageToUI(message, sender, isHtml = false, skipDuplicateCheck = false) {
    // Check for duplicates unless explicitly skipped (like during restore)
    if (!skipDuplicateCheck && this.isMessageDuplicate(message)) {
      console.log('‚è≠Ô∏è Skipping duplicate message:', message.substring(0, 50));
      return;
    }

    // Track this message
    const messageHash = this.hashMessage(message);
    if (messageHash) {
      this.conversationContext.processedMessages.add(messageHash);
    }

    // Add to UI using existing functions
    if (window.addChatMessage) {
      window.addChatMessage(message, sender, isHtml);
    } else if (sender === 'bot' && window.addBotMessage) {
      window.addBotMessage(message);
    } else {
      console.log(`[${sender}]:`, message);
    }

    // Add to context
    if (sender === 'bot') {
      this.conversationContext.messages.push({
        sender: 'bot',
        message: message,
        timestamp: new Date().toISOString(),
        isHtml: isHtml
      });
    }
  }

  sendMessage(text) {
    this.conversationContext.messages.push({
      sender: 'user',
      message: text,
      timestamp: new Date().toISOString()
    });

    // Track as processed
    const messageHash = this.hashMessage(text);
    if (messageHash) {
      this.conversationContext.processedMessages.add(messageHash);
    }

    // Log to Google Apps Script if configured
    if (this.config.loggingUrl) {
      this.logToGoogleSheets({
        sessionId: this.sessionId,
        sender: 'user',
        message: text,
        timestamp: new Date().toISOString(),
        shopDomain: this.config.shopDomain
      });
    }

    this.saveSession();
  }

  /**
   * ========================================
   * ORDER & SUBSCRIPTION INFO
   * ========================================
   */

  promptOrderLookup() {
    const orderNumber = prompt('Enter your order number (e.g., #1234):');
    if (orderNumber) {
      this.lookupOrder(orderNumber.replace('#', ''));
    }
  }

  async lookupOrder(orderNumber) {
    if (!this.config.customer) {
      this.addMessageToUI('Please sign in to view your orders.', 'bot');
      return;
    }

    this.addMessageToUI('Looking up your order...', 'bot');
    
    const message = `
      <div style="padding: 16px; background: #f8f8f8; border-radius: 8px; margin: 8px 0;">
        <p style="margin: 0 0 12px 0;"><strong>Order Lookup</strong></p>
        <p style="margin: 0 0 12px 0; font-size: 14px;">
          To view your order #${orderNumber}, please visit your account page.
        </p>
        <a href="/account" style="
          display: inline-block;
          padding: 10px 20px;
          background: #000;
          color: white;
          text-decoration: none;
          border-radius: 4px;
          font-size: 14px;
        ">View My Orders</a>
      </div>
    `;
    
    this.addMessageToUI(message, 'bot', true);
  }

  showOrderHistory() {
    if (!this.config.customer) {
      this.addMessageToUI('Please sign in to view your order history.', 'bot');
      return;
    }

    const message = `
      <div style="padding: 16px; background: #f8f8f8; border-radius: 8px;">
        <p style="margin: 0 0 12px 0;"><strong>Your Order History</strong></p>
        <a href="/account" style="
          display: inline-block;
          padding: 10px 20px;
          background: #000;
          color: white;
          text-decoration: none;
          border-radius: 4px;
        ">View All Orders</a>
      </div>
    `;
    
    this.addMessageToUI(message, 'bot', true);
  }

  showSubscriptionInfo() {
    if (!this.config.customer) {
      this.addMessageToUI('Please sign in to manage your subscriptions.', 'bot');
      return;
    }

    const message = `
      <div style="padding: 16px; background: #f8f8f8; border-radius: 8px;">
        <p style="margin: 0 0 12px 0;"><strong>Manage Your Subscriptions</strong></p>
        <p style="margin: 0 0 12px 0; font-size: 14px;">
          You can pause, skip, or cancel your subscriptions anytime.
        </p>
        <a href="/account" style="
          display: inline-block;
          padding: 10px 20px;
          background: #000;
          color: white;
          text-decoration: none;
          border-radius: 4px;
          margin-right: 8px;
        ">Manage Subscriptions</a>
      </div>
    `;
    
    this.addMessageToUI(message, 'bot', true);
  }

  showAccountInfo() {
    if (!this.config.customer) {
      this.addMessageToUI('Please sign in to view your account information.', 'bot');
      return;
    }

    const customer = this.config.customer;
    const message = `
      <div style="padding: 16px; background: #f8f8f8; border-radius: 8px;">
        <p style="margin: 0 0 12px 0;"><strong>Your Account</strong></p>
        <p style="margin: 0 0 6px 0; font-size: 14px;">
          <strong>Name:</strong> ${customer.first_name} ${customer.last_name}
        </p>
        <p style="margin: 0 0 12px 0; font-size: 14px;">
          <strong>Email:</strong> ${customer.email}
        </p>
        <a href="/account" style="
          display: inline-block;
          padding: 10px 20px;
          background: #000;
          color: white;
          text-decoration: none;
          border-radius: 4px;
        ">Edit Account</a>
      </div>
    `;
    
    this.addMessageToUI(message, 'bot', true);
  }

  /**
   * ========================================
   * CHAT HISTORY & GDPR (unchanged)
   * ========================================
   */

  showWelcomeBack() {
    if (!this.config.customer?.email) return;

    try {
      const historyKey = 'chat_history_' + this.hashEmail(this.config.customer.email);
      const history = JSON.parse(localStorage.getItem(historyKey) || '[]');

      if (history.length > 0) {
        const lastSession = history[history.length - 1];
        const lastDate = new Date(lastSession.timestamp).toLocaleDateString();
        
        const message = `Welcome back, ${this.config.customer.first_name}! Last time we chatted on ${lastDate}. How can I help you today?`;
        
        setTimeout(() => {
          this.addMessageToUI(message, 'bot');
        }, 1000);
      }
    } catch (error) {
      console.error('Failed to show welcome back:', error);
    }
  }

  initGDPRTools() {
    const gdprButton = document.createElement('button');
    gdprButton.innerHTML = 'üîí Privacy';
    gdprButton.style.cssText = `
      position: absolute;
      top: 16px;
      right: 16px;
      padding: 6px 12px;
      background: transparent;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      z-index: 100;
    `;

    gdprButton.addEventListener('click', () => this.showGDPROptions());

    const chatHeader = document.querySelector('.chat-header') ||
                      document.querySelector('[data-chat-header]');

    if (chatHeader) {
      chatHeader.style.position = 'relative';
      chatHeader.appendChild(gdprButton);
    }
  }

  showGDPROptions() {
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    `;

    modal.innerHTML = `
      <div style="
        background: white;
        padding: 28px;
        border-radius: 12px;
        max-width: 420px;
        width: 90%;
        box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      ">
        <h3 style="margin: 0 0 8px 0; font-size: 20px;">üîí Your Privacy & Data</h3>
        <p style="font-size: 14px; color: #666; margin: 0 0 20px 0;">
          All your chat data is stored locally in your browser. You have full control.
        </p>
        
        <button id="gdpr-export" style="
          width: 100%;
          padding: 14px;
          margin-bottom: 10px;
          background: #4CAF50;
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 15px;
          font-weight: 500;
        ">üì• Export My Data</button>
        
        <button id="gdpr-delete" style="
          width: 100%;
          padding: 14px;
          margin-bottom: 10px;
          background: #f44336;
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 15px;
          font-weight: 500;
        ">üóëÔ∏è Delete My Data</button>
        
        <button id="gdpr-close" style="
          width: 100%;
          padding: 14px;
          background: #f5f5f5;
          color: #333;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 15px;
          font-weight: 500;
        ">Close</button>
      </div>
    `;

    document.body.appendChild(modal);

    modal.querySelector('#gdpr-export').addEventListener('click', () => {
      modal.remove();
      this.exportData();
    });

    modal.querySelector('#gdpr-delete').addEventListener('click', () => {
      modal.remove();
      this.deleteData();
    });

    modal.querySelector('#gdpr-close').addEventListener('click', () => {
      modal.remove();
    });

    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
  }

  exportData() {
    try {
      const data = {
        exportDate: new Date().toISOString(),
        customer: this.config.customer ? {
          email: this.config.customer.email,
          name: `${this.config.customer.first_name} ${this.config.customer.last_name}`
        } : null,
        sessionData: JSON.parse(localStorage.getItem('chat_session_data') || '{}'),
        chatHistory: this.config.customer ? 
          JSON.parse(localStorage.getItem('chat_history_' + this.hashEmail(this.config.customer.email)) || '[]') :
          [],
        format: 'JSON',
        note: 'All data is stored locally in your browser'
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `chat-data-export-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);

      alert('‚úÖ Your data has been exported and downloaded!');
    } catch (error) {
      console.error('Export failed:', error);
      alert('‚ùå Failed to export data. Please try again.');
    }
  }

  deleteData() {
    const confirmed = confirm(
      'Are you sure you want to delete all your chat data?\n\nThis will remove:\n- Current chat session\n- Chat history\n- All saved preferences\n\nThis action cannot be undone.'
    );

    if (!confirmed) return;

    try {
      localStorage.removeItem('chat_session_id');
      localStorage.removeItem('chat_session_data');
      
      if (this.config.customer?.email) {
        const historyKey = 'chat_history_' + this.hashEmail(this.config.customer.email);
        localStorage.removeItem(historyKey);
      }

      this.conversationContext = {
        messages: [],
        lastIntent: null,
        metadata: {},
        processedMessages: new Set(),
        quickRepliesShown: false
      };

      alert('‚úÖ All your chat data has been deleted.');
      window.location.reload();
    } catch (error) {
      console.error('Delete failed:', error);
      alert('‚ùå Failed to delete data. Please try again.');
    }
  }

  /**
   * ========================================
   * UTILITY FUNCTIONS
   * ========================================
   */

  async logToGoogleSheets(data) {
    if (!this.config.loggingUrl) return;
    
    try {
      await fetch(this.config.loggingUrl, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
    } catch (error) {
      console.error('Logging failed:', error);
    }
  }

  hashEmail(email) {
    let hash = 0;
    for (let i = 0; i < email.length; i++) {
      const char = email.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    return hash.toString(36);
  }

  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  updateContext(intent, metadata = {}) {
    this.conversationContext.lastIntent = intent;
    this.conversationContext.metadata = {
      ...this.conversationContext.metadata,
      ...metadata
    };
    
    // Reset quick replies shown flag when intent changes
    this.conversationContext.quickRepliesShown = false;
    
    // Update quick replies with new context
    if (this.config.enableQuickReplies) {
      setTimeout(() => {
        this.updateQuickReplies({ intent });
      }, 100);
    }
    
    this.saveSession();
  }

  // Public method to manually clear duplicates
  resetDuplicateTracking() {
    this.conversationContext.processedMessages.clear();
    this.conversationContext.quickRepliesShown = false;
    console.log('‚úÖ Duplicate tracking reset');
  }
}

// Export
if (typeof window !== 'undefined') {
  window.ShopifyChatFeatures = ShopifyChatFeatures;
}
